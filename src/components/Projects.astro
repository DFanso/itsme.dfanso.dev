---
import { Icon } from 'astro-icon/components';
const { class: className } = Astro.props;

// Helper function to fetch GitHub stats
async function getGitHubStats(repo: string) {
    try {
        const response = await fetch(`https://api.github.com/repos/${repo}`, {
            headers: {
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'Portfolio-Site'
            }
        });
        if (!response.ok) return null;
        const data = await response.json();
        return {
            stars: data.stargazers_count || 0,
            forks: data.forks_count || 0,
            watchers: data.subscribers_count || 0
        };
    } catch (error) {
        console.error(`Failed to fetch stats for ${repo}:`, error);
        return null;
    }
}

const projectsData = [
    {
        type: 'OPS',
        name: 'eks-gitops-platform',
        url: 'https://github.com/DFanso?tab=repositories&q=DevOps-Project-001&type=&language=&sort=',
        github: 'DFanso/DevOps-Project-001',
        description: 'Production-grade 3-repo GitOps platform on AWS EKS with Terraform IaC, GitHub Actions CI, and ArgoCD for continuous deployment with DataDog observability.',
        tech: [
            { icon: 'simple-icons:amazonaws', name: 'AWS EKS' },
            { icon: 'simple-icons:terraform', name: 'Terraform' },
            { icon: 'simple-icons:kubernetes', name: 'Kubernetes' },
            { icon: 'simple-icons:helm', name: 'Helm' },
            { icon: 'simple-icons:argo', name: 'ArgoCD' },
            { icon: 'simple-icons:datadog', name: 'DataDog' },
            { icon: 'simple-icons:githubactions', name: 'GitHub Actions' },
            { icon: 'simple-icons:go', name: 'Go' }
        ]
    },
    {
        type: 'OPS',
        name: 'k3s-cicd',
        url: 'https://github.com/DFanso/k3s',
        github: 'DFanso/k3s',
        description: 'A complete Kubernetes deployment setup with automated CI/CD using GitHub Actions, Helm, and full observability stack.',
        tech: [
            { icon: 'simple-icons:kubernetes', name: 'K3s' },
            { icon: 'simple-icons:githubactions', name: 'GitHub Actions' },
            { icon: 'simple-icons:helm', name: 'Helm' },
            { icon: 'simple-icons:prometheus', name: 'Prometheus' },
            { icon: 'simple-icons:grafana', name: 'Grafana' },
            { icon: 'simple-icons:nginx', name: 'Nginx' },
            { icon: 'simple-icons:fastapi', name: 'FastAPI' }
        ]
    },
    {
        type: 'WEB',
        name: 'techxeed',
        url: 'https://www.techxeed.com/',
        github: null,
        description: 'A comprehensive digital solutions platform offering web development, mobile apps, \nAI solutions, and digital marketing services.',
        tech: [
            { icon: 'simple-icons:nextdotjs', name: 'Next.js' },
            { icon: 'simple-icons:nestjs', name: 'Nest.js' },
            { icon: 'simple-icons:mongodb', name: 'MongoDB' },
            { icon: 'simple-icons:tailwindcss', name: 'TailwindCSS' },
            { icon: 'simple-icons:firebase', name: 'Firebase' },
            { icon: 'simple-icons:amazonaws', name: 'AWS' },
            { icon: 'simple-icons:stripe', name: 'Stripe' },
            { icon: 'simple-icons:terraform', name: 'Terraform' }
        ]
    },
    {
        type: 'APP',
        name: 'quickquest',
        url: 'https://github.com/DFanso/QuickQuest',
        github: 'DFanso/QuickQuest',
        description: 'A location-based platform connecting customers with laborers, featuring real-time chat \nvia SSE and geospatial queries.',
        tech: [
            { icon: 'simple-icons:nextdotjs', name: 'Next.js' },
            { icon: 'simple-icons:nestjs', name: 'Nest.js' },
            { icon: 'simple-icons:mongodb', name: 'MongoDB' },
            { icon: 'simple-icons:python', name: 'Python' },
            { icon: 'simple-icons:amazonaws', name: 'AWS' },
            { icon: 'simple-icons:paypal', name: 'PayPal' }
        ]
    },
    {
        type: 'APP',
        name: 'rss-reader',
        url: 'https://github.com/DFanso/rss',
        github: 'DFanso/rss',
        description: 'A simple, modern RSS reader and generator built with Go and HTMX, featuring \npersistent storage and a clean UI.',
        tech: [
            { icon: 'simple-icons:go', name: 'Go' },
            { icon: 'simple-icons:htmx', name: 'HTMX' },
            { icon: 'simple-icons:tailwindcss', name: 'TailwindCSS' }
        ]
    },
    {
        type: 'CLI',
        name: 'commit-msg',
        url: 'https://github.com/DFanso/commit-msg',
        github: 'DFanso/commit-msg',
        description: 'AI-powered CLI tool that generates conventional commit messages using various \nLLMs including Gemini, Grok, and OpenAI.',
        tech: [
            { icon: 'simple-icons:go', name: 'Go' },
            { icon: 'lucide:brain', name: 'LLMs' }
        ]
    },
    {
        type: 'OPS',
        name: 'aws-ecs-infra',
        url: 'https://github.com/DFanso/aws-ecs-infrastructure',
        github: 'DFanso/aws-ecs-infrastructure',
        description: 'Infrastructure as Code configurations for deploying scalable applications on \nAWS ECS using Terraform.',
        tech: [
            { icon: 'simple-icons:terraform', name: 'Terraform' },
            { icon: 'simple-icons:amazonaws', name: 'AWS' }
        ]
    }
];

// Fetch GitHub stats for all projects at build time
const projects = await Promise.all(
    projectsData.map(async (project) => {
        const stats = project.github ? await getGitHubStats(project.github) : null;
        return { ...project, stats };
    })
);
---

<section class:list={[className]}>
    <div class="command-output">
        <div class="text-[#bb9af7] font-bold mb-2">Featured Projects</div>
        <div class="space-y-6">
            {projects.map((project, index) => (
                <div class="project-entry">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-[#565f89]">{index === projects.length - 1 ? '└─▶' : '├─▶'}</span>
                        <span class="text-[#e0af68]">cat</span>
                        <a href={project.url} target="_blank" rel="noopener noreferrer" class="text-[#7aa2f7] hover:underline">projects/{project.name}/</a>
                        <span class="text-[#565f89]">type:</span>
                        <span class="text-[#f7768e]">{project.type}</span>
                        {project.stats && (
                            <div class="flex items-center gap-3 ml-2">
                                <span class="flex items-center gap-1 text-[#e0af68]">
                                    <Icon name="lucide:star" class="w-3.5 h-3.5" />
                                    <span class="text-sm">{project.stats.stars}</span>
                                </span>
                                <span class="flex items-center gap-1 text-[#7dcfff]">
                                    <Icon name="lucide:git-fork" class="w-3.5 h-3.5" />
                                    <span class="text-sm">{project.stats.forks}</span>
                                </span>
                                <span class="flex items-center gap-1 text-[#bb9af7]">
                                    <Icon name="lucide:eye" class="w-3.5 h-3.5" />
                                    <span class="text-sm">{project.stats.watchers}</span>
                                </span>
                            </div>
                        )}
                    </div>
                    <div class="ml-6 mt-2">
                        <div class="text-[#c0caf5]">{project.description}</div>
                        <div class="mt-2 flex flex-wrap gap-3">
                            {project.tech.map(tech => (
                                <div class="flex items-center gap-1">
                                    <span class="text-[#565f89]">│</span>
                                    <span class="text-[#7aa2f7]">
                                        <Icon name={tech.icon} class="w-4 h-4" />
                                    </span>
                                    <span class="text-[#9ece6a] text-sm">{tech.name}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            ))}
        </div>
    </div>
</section>