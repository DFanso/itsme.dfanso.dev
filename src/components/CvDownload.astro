---
const { class: className } = Astro.props;

// Import data from other components
const personalInfo = {
    name: "Leo Felcianas",
    title: "Associate DevOps Engineer at Empite",
    email: "leogavin123@outlook.com",
    summary: "DevOps/Backend specialist crafting efficient and scalable solutions. \nTransforming complex challenges into elegant architectures."
};

// From Skills.astro
const skillCategories = [
    {
        name: 'cloud',
        skills: [
            { icon: 'â ¿', name: 'AWS' },
            { icon: 'âš¡', name: 'Azure' },
            { icon: 'â˜', name: 'Cloudflare' }
        ]
    },
    {
        name: 'containers',
        skills: [
            { icon: 'ðŸ³', name: 'Docker' },
            { icon: 'â˜¸', name: 'Kubernetes' }
        ]
    },
    {
        name: 'infra',
        skills: [
            { icon: 'âš™', name: 'Terraform' },
            { icon: 'âš¡', name: 'Jenkins' },
            { icon: 'â­', name: 'GitHub-Actions' }
        ]
    },
    {
        name: 'lang',
        skills: [
            { icon: 'âš¡', name: 'Go' },
            { icon: 'ðŸ', name: 'Python' },
            { icon: 'âš›', name: 'TypeScript' },
            { icon: 'â¬¡', name: 'Node.js' }
        ]
    },
    {
        name: 'db',
        skills: [
            { icon: 'ðŸ˜', name: 'PostgreSQL' },
            { icon: 'ðŸƒ', name: 'MongoDB' },
            { icon: 'âš¡', name: 'Redis' }
        ]
    },
    {
        name: 'monitor',
        skills: [
            { icon: 'ðŸ“Š', name: 'Prometheus' },
            { icon: 'ðŸ“ˆ', name: 'Grafana' },
            { icon: 'ðŸ”', name: 'ELK' }
        ]
    },
    {
        name: 'arch',
        skills: [
            { icon: 'âš¡', name: 'Microservices' },
            { icon: 'âš™', name: 'System' },
            { icon: 'ðŸ”’', name: 'Network' }
        ]
    }
];

// From Experience.astro
const experiences = [
    {
        type: 'DEV',
        file: 'empite.md',
        title: 'Associate DevOps Engineer',
        company: 'Empite',
        period: 'November 2024 - Present',
        responsibilities: [
            'Building and maintaining CI/CD pipelines using Azure DevOps',
            'Developing backend services using NestJS and TypeScript',
            'Infrastructure as Code (IaC) implementation with Terraform',
            'Container orchestration with Docker and Kubernetes'
        ]
    },
    {
        type: 'INT',
        file: 'intern.md',
        title: 'Software Engineer Intern',
        company: 'Empite',
        period: 'July 2024 - October 2024',
        responsibilities: [
            'Developed web applications using modern frameworks',
            'Collaborated with senior developers on project implementations',
            'Participated in code reviews and agile development processes'
        ]
    },
    {
        type: 'FRL',
        file: 'freelance.md',
        title: 'Software Engineer',
        company: 'Freelance',
        period: 'May 2023 - Present',
        responsibilities: [
            'Developing custom web and mobile applications for clients',
            'Implementing full-stack solutions with modern technologies',
            'Managing client relationships and project deliverables'
        ]
    }
];

// From Projects.astro
const projects = [
    {
        type: 'WEB',
        name: 'Techxeed',
        description: 'A comprehensive digital solutions platform offering web development, \nmobile apps, AI solutions, and digital marketing services.',
        tech: [
            { icon: 'âš›', name: 'Next.js' },
            { icon: 'â¬¡', name: 'Nest.js' },
            { icon: 'ðŸƒ', name: 'MongoDB' },
            { icon: 'ðŸŽ¨', name: 'TailwindCSS' },
            { icon: 'ðŸ”¥', name: 'Firebase' },
            { icon: 'â ¿', name: 'AWS' }
        ]
    },
    {
        type: 'APP',
        name: 'QuickQuest',
        description: 'A location-based platform connecting customers with laborers, \nfeaturing real-time chat via SSE and geospatial queries.',
        tech: [
            { icon: 'âš›', name: 'Next.js' },
            { icon: 'â¬¡', name: 'Nest.js' },
            { icon: 'ðŸƒ', name: 'MongoDB' },
            { icon: 'ðŸ', name: 'Python' },
            { icon: 'â ¿', name: 'AWS' }
        ]
    },
    {
        type: 'SYS',
        name: 'CineMagic',
        description: 'A comprehensive cinema ticket booking system with \nreal-time seat selection and secure payments.',
        tech: [
            { icon: 'âš›', name: 'React.js' },
            { icon: 'âš¡', name: 'Redux' },
            { icon: 'â¬¡', name: 'Nest.js' },
            { icon: 'ðŸƒ', name: 'MongoDB' }
        ]
    }
];

function truncateText(text: string, maxLength: number) {
    return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
}

function generateCVContent() {
    const sections = [
        { 
            title: "LEO FELCIANAS",
            isHeader: true,
            content: `${personalInfo.title}\n${personalInfo.email}`
        },
        { 
            title: "PROFESSIONAL SUMMARY",
            content: truncateText(personalInfo.summary, 150)
        },
        { 
            title: "TECHNICAL SKILLS",
            content: skillCategories.map(category => 
                `${category.name.toUpperCase()}: ${category.skills.map(skill => skill.name).join(" | ")}`
            ).join("\n")
        },
        { 
            title: "PROFESSIONAL EXPERIENCE",
            content: experiences.map(job => 
                `${job.title} - ${job.company} (${job.period})\n${job.responsibilities.slice(0, 3).map(r => `â€¢ ${truncateText(r, 80)}`).join("\n")}`
            ).join("\n\n")
        },
        { 
            title: "KEY PROJECTS",
            content: projects.map(project => 
                `${project.name}: ${truncateText(project.description, 100)}\nStack: ${project.tech.map(t => t.name).join(" | ")}`
            ).join("\n\n")
        },
        { 
            title: "EDUCATION",
            content: "Bachelor of Science (Honours) in Software Engineering\nUniversity of Plymouth"
        }
    ];

    return sections;
}

const cvSections = generateCVContent();
---

<div class:list={["mt-4", className]}>
    <button
        id="downloadCV"
        class="flex items-center gap-2 px-4 py-2 bg-[#7aa2f7] text-[#1a1b26] rounded hover:bg-[#9ece6a] transition-colors"
        data-sections={cvSections.map(section => `${section.title}:::${section.content}:::${section.isHeader || false}`).join('|||')}
    >
        <span class="command-prompt">$</span> download-cv
    </button>
</div>

<script>
    import { jsPDF } from 'jspdf';

    const downloadButton = document.getElementById('downloadCV');
    if (!downloadButton) throw new Error('Download button not found');

    downloadButton.addEventListener('click', () => {
        const sectionsData = downloadButton.getAttribute('data-sections');
        if (!sectionsData) throw new Error('CV sections data not found');

        const doc = new jsPDF();
        const sections = sectionsData.split('|||');
        
        let y = 15;
        const margin = 15;
        const lineHeight = 6;
        
        sections.forEach(section => {
            const [title, content, isHeader] = section.split(':::');
            
            if (isHeader === 'true') {
                // Header formatting
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.text(title, margin, y);
                y += lineHeight;
                
                doc.setFontSize(10);
                const lines = content.split('\n');
                lines.forEach(line => {
                    doc.text(line, margin, y);
                    y += lineHeight;
                });
            } else {
                // Section title
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(title, margin, y);
                y += lineHeight;
                
                // Section content
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                
                const lines = content.split('\n');
                lines.forEach(line => {
                    // Handle bullet points with proper indentation
                    if (line.startsWith('â€¢')) {
                        doc.text(line, margin + 4, y);
                    } else {
                        doc.text(line, margin, y);
                    }
                    y += lineHeight;
                });
                
                y += lineHeight * 0.5; // Reduced space between sections
            }
        });
        
        doc.save('Leo_Felcianas_CV.pdf');
    });
</script>

<style>
    button {
        font-family: monospace;
        font-size: 0.875rem;
        font-weight: 500;
    }
</style> 