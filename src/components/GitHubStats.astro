---
import { Icon } from 'astro-icon/components';
const { class: className } = Astro.props;

const GITHUB_USERNAME = 'DFanso';

// Fetch GitHub data using GraphQL API (requires token for full features)
async function fetchGitHubGraphQL() {
    const token = import.meta.env.GITHUB_TOKEN;
    
    if (!token) {
        return null;
    }
    
    const query = `
        query($username: String!) {
            user(login: $username) {
                name
                login
                avatarUrl
                bio
                followers { totalCount }
                following { totalCount }
                repositories(first: 100, ownerAffiliations: OWNER, orderBy: {field: STARGAZERS, direction: DESC}) {
                    totalCount
                    nodes {
                        name
                        stargazerCount
                        forkCount
                        primaryLanguage {
                            name
                            color
                        }
                    }
                }
                pinnedItems(first: 6, types: REPOSITORY) {
                    nodes {
                        ... on Repository {
                            name
                            description
                            url
                            stargazerCount
                            forkCount
                            primaryLanguage {
                                name
                                color
                            }
                        }
                    }
                }
                contributionsCollection {
                    totalCommitContributions
                    totalPullRequestContributions
                    totalIssueContributions
                    totalRepositoryContributions
                    contributionCalendar {
                        totalContributions
                        weeks {
                            contributionDays {
                                contributionCount
                                date
                                weekday
                            }
                        }
                    }
                }
            }
        }
    `;

    try {
        const response = await fetch('https://api.github.com/graphql', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'User-Agent': 'Portfolio-Site'
            },
            body: JSON.stringify({
                query,
                variables: { username: GITHUB_USERNAME }
            })
        });

        if (!response.ok) {
            console.error('GitHub GraphQL API error:', response.status);
            return null;
        }

        const data = await response.json();
        return data.data?.user;
    } catch (error) {
        console.error('Failed to fetch GitHub GraphQL data:', error);
        return null;
    }
}

// Fallback: Fetch using public REST API (no token required)
async function fetchGitHubREST() {
    try {
        const [userResponse, reposResponse] = await Promise.all([
            fetch(`https://api.github.com/users/${GITHUB_USERNAME}`, {
                headers: { 'Accept': 'application/vnd.github.v3+json', 'User-Agent': 'Portfolio-Site' }
            }),
            fetch(`https://api.github.com/users/${GITHUB_USERNAME}/repos?sort=stars&direction=desc&per_page=100`, {
                headers: { 'Accept': 'application/vnd.github.v3+json', 'User-Agent': 'Portfolio-Site' }
            })
        ]);
        
        if (!userResponse.ok || !reposResponse.ok) return null;
        
        const user = await userResponse.json();
        const repos = await reposResponse.json();
        
        return { user, repos };
    } catch (error) {
        console.error('Failed to fetch GitHub REST data:', error);
        return null;
    }
}

// Language colors
function getLanguageColor(language: string): string {
    const colors: Record<string, string> = {
        'TypeScript': '#3178c6', 'JavaScript': '#f1e05a', 'Python': '#3572A5',
        'Go': '#00ADD8', 'Rust': '#dea584', 'Java': '#b07219', 'C#': '#178600',
        'C++': '#f34b7d', 'C': '#555555', 'PHP': '#4F5D95', 'Ruby': '#701516',
        'Swift': '#F05138', 'Kotlin': '#A97BFF', 'Dart': '#00B4AB', 'Shell': '#89e051',
        'HTML': '#e34c26', 'CSS': '#563d7c', 'Vue': '#41b883', 'Svelte': '#ff3e00',
        'Astro': '#ff5a03', 'HCL': '#844FBA', 'Dockerfile': '#384d54',
    };
    return colors[language] || '#8b8b8b';
}

// Calculate language stats
function calculateLanguageStats(repos: any[], isGraphQL: boolean) {
    const langCount: Record<string, { count: number; color: string }> = {};
    
    repos.forEach(repo => {
        const lang = isGraphQL ? repo.primaryLanguage?.name : repo.language;
        const color = isGraphQL ? repo.primaryLanguage?.color : getLanguageColor(lang);
        if (lang) {
            if (!langCount[lang]) langCount[lang] = { count: 0, color: color || '#8b8b8b' };
            langCount[lang].count++;
        }
    });

    const total = Object.values(langCount).reduce((sum, l) => sum + l.count, 0);
    return Object.entries(langCount)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 8)
        .map(([name, data]) => ({ name, percentage: Math.round((data.count / total) * 100), color: data.color }));
}

// Get contribution level for heatmap
function getContributionLevel(count: number): number {
    if (count === 0) return 0;
    if (count <= 3) return 1;
    if (count <= 6) return 2;
    if (count <= 9) return 3;
    return 4;
}

// Try GraphQL first, fallback to REST
const graphqlData = await fetchGitHubGraphQL();
const restData = !graphqlData ? await fetchGitHubREST() : null;
const hasFullData = !!graphqlData;

// Process data based on source
let languageStats: any[] = [];
let topRepos: any[] = [];
let pinnedRepos: any[] = [];
let contributionCalendar: any = null;
let stats = { commits: 0, prs: 0, issues: 0, repos: 0, stars: 0, forks: 0, followers: 0, contributions: 0 };

if (graphqlData) {
    const repos = graphqlData.repositories.nodes;
    languageStats = calculateLanguageStats(repos, true);
    pinnedRepos = graphqlData.pinnedItems.nodes;
    contributionCalendar = graphqlData.contributionsCollection.contributionCalendar;
    
    stats = {
        commits: graphqlData.contributionsCollection.totalCommitContributions,
        prs: graphqlData.contributionsCollection.totalPullRequestContributions,
        issues: graphqlData.contributionsCollection.totalIssueContributions,
        repos: graphqlData.repositories.totalCount,
        stars: repos.reduce((sum: number, r: any) => sum + r.stargazerCount, 0),
        forks: repos.reduce((sum: number, r: any) => sum + r.forkCount, 0),
        followers: graphqlData.followers.totalCount,
        contributions: contributionCalendar.totalContributions
    };
    
    // Use pinned repos or top starred repos
    topRepos = pinnedRepos.length > 0 ? pinnedRepos : repos.slice(0, 6);
} else if (restData) {
    const { user, repos } = restData;
    languageStats = calculateLanguageStats(repos, false);
    topRepos = repos.filter((r: any) => !r.fork).slice(0, 6);
    
    stats = {
        commits: 0, prs: 0, issues: 0,
        repos: user.public_repos,
        stars: repos.reduce((sum: number, r: any) => sum + (r.stargazers_count || 0), 0),
        forks: repos.reduce((sum: number, r: any) => sum + (r.forks_count || 0), 0),
        followers: user.followers,
        contributions: 0
    };
}

const recentWeeks = contributionCalendar?.weeks || [];
const hasData = graphqlData || restData;
---

<section class:list={[className]}>
    <div class="command-output">
        <div class="text-[#bb9af7] font-bold mb-4">GitHub Statistics</div>
        
        {hasData ? (
            <div class="space-y-6">
                <!-- Aggregate Stats -->
                <div class="stats-grid">
                    <div class="text-[#7aa2f7] mb-2 flex items-center gap-2">
                        <Icon name="simple-icons:github" class="w-4 h-4" />
                        <span>@{GITHUB_USERNAME}</span>
                        {hasFullData && <span class="text-[#9ece6a] text-xs">(Last Year)</span>}
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 ml-4">
                        {hasFullData && (
                            <>
                                <div class="stat-item">
                                    <div class="flex items-center gap-1 text-[#565f89]">
                                        <span>│</span>
                                        <Icon name="lucide:git-commit" class="w-3.5 h-3.5 text-[#9ece6a]" />
                                    </div>
                                    <div class="text-[#c0caf5] text-lg font-bold">{stats.commits.toLocaleString()}</div>
                                    <div class="text-[#565f89] text-xs">Commits</div>
                                </div>
                                <div class="stat-item">
                                    <div class="flex items-center gap-1 text-[#565f89]">
                                        <span>│</span>
                                        <Icon name="lucide:git-pull-request" class="w-3.5 h-3.5 text-[#bb9af7]" />
                                    </div>
                                    <div class="text-[#c0caf5] text-lg font-bold">{stats.prs.toLocaleString()}</div>
                                    <div class="text-[#565f89] text-xs">Pull Requests</div>
                                </div>
                                <div class="stat-item">
                                    <div class="flex items-center gap-1 text-[#565f89]">
                                        <span>│</span>
                                        <Icon name="lucide:circle-dot" class="w-3.5 h-3.5 text-[#f7768e]" />
                                    </div>
                                    <div class="text-[#c0caf5] text-lg font-bold">{stats.issues.toLocaleString()}</div>
                                    <div class="text-[#565f89] text-xs">Issues</div>
                                </div>
                            </>
                        )}
                        <div class="stat-item">
                            <div class="flex items-center gap-1 text-[#565f89]">
                                <span>│</span>
                                <Icon name="lucide:star" class="w-3.5 h-3.5 text-[#e0af68]" />
                            </div>
                            <div class="text-[#c0caf5] text-lg font-bold">{stats.stars.toLocaleString()}</div>
                            <div class="text-[#565f89] text-xs">Total Stars</div>
                        </div>
                        {!hasFullData && (
                            <>
                                <div class="stat-item">
                                    <div class="flex items-center gap-1 text-[#565f89]">
                                        <span>│</span>
                                        <Icon name="lucide:git-fork" class="w-3.5 h-3.5 text-[#7dcfff]" />
                                    </div>
                                    <div class="text-[#c0caf5] text-lg font-bold">{stats.forks.toLocaleString()}</div>
                                    <div class="text-[#565f89] text-xs">Total Forks</div>
                                </div>
                                <div class="stat-item">
                                    <div class="flex items-center gap-1 text-[#565f89]">
                                        <span>│</span>
                                        <Icon name="lucide:book" class="w-3.5 h-3.5 text-[#7aa2f7]" />
                                    </div>
                                    <div class="text-[#c0caf5] text-lg font-bold">{stats.repos}</div>
                                    <div class="text-[#565f89] text-xs">Repositories</div>
                                </div>
                                <div class="stat-item">
                                    <div class="flex items-center gap-1 text-[#565f89]">
                                        <span>│</span>
                                        <Icon name="lucide:users" class="w-3.5 h-3.5 text-[#bb9af7]" />
                                    </div>
                                    <div class="text-[#c0caf5] text-lg font-bold">{stats.followers}</div>
                                    <div class="text-[#565f89] text-xs">Followers</div>
                                </div>
                            </>
                        )}
                    </div>
                </div>

                <!-- Contribution Graph (only with token) -->
                {hasFullData && recentWeeks.length > 0 && (
                    <div class="contribution-graph">
                        <div class="text-[#7aa2f7] mb-2 flex items-center gap-2">
                            <span class="text-[#565f89]">├─▶</span>
                            <span class="text-[#e0af68]">cat</span>
                            <span>contributions.heatmap</span>
                        </div>
                        <div class="ml-6 overflow-x-auto">
                            <div class="contribution-calendar flex gap-[3px] pb-2">
                                {recentWeeks.map((week: any) => (
                                    <div class="week flex flex-col gap-[3px]">
                                        {week.contributionDays.map((day: any) => (
                                            <div 
                                                class="contribution-day w-[10px] h-[10px] sm:w-[12px] sm:h-[12px] rounded-sm transition-all hover:ring-1 hover:ring-[#7aa2f7]"
                                                data-level={getContributionLevel(day.contributionCount)}
                                                title={`${day.date}: ${day.contributionCount} contributions`}
                                            />
                                        ))}
                                    </div>
                                ))}
                            </div>
                            <div class="flex items-center gap-2 mt-2 text-xs text-[#565f89]">
                                <span>Less</span>
                                <div class="flex gap-[3px]">
                                    <div class="w-[10px] h-[10px] rounded-sm bg-[#1a1b26] border border-[#7aa2f7]/20"></div>
                                    <div class="w-[10px] h-[10px] rounded-sm bg-[#0e4429]"></div>
                                    <div class="w-[10px] h-[10px] rounded-sm bg-[#006d32]"></div>
                                    <div class="w-[10px] h-[10px] rounded-sm bg-[#26a641]"></div>
                                    <div class="w-[10px] h-[10px] rounded-sm bg-[#39d353]"></div>
                                </div>
                                <span>More</span>
                                <span class="ml-4 text-[#9ece6a]">{stats.contributions} contributions this year</span>
                            </div>
                        </div>
                    </div>
                )}

                <!-- Top Languages -->
                <div class="languages">
                    <div class="text-[#7aa2f7] mb-2 flex items-center gap-2">
                        <span class="text-[#565f89]">├─▶</span>
                        <span class="text-[#e0af68]">cat</span>
                        <span>languages.stats</span>
                    </div>
                    <div class="ml-6">
                        <div class="language-bar flex h-3 rounded-full overflow-hidden mb-2 bg-[#1a1b26]">
                            {languageStats.map((lang) => (
                                <div 
                                    class="language-segment transition-all hover:opacity-80"
                                    style={`width: ${lang.percentage}%; background-color: ${lang.color};`}
                                    title={`${lang.name}: ${lang.percentage}%`}
                                />
                            ))}
                        </div>
                        <div class="flex flex-wrap gap-3 text-sm">
                            {languageStats.map((lang) => (
                                <div class="flex items-center gap-1">
                                    <span class="w-2.5 h-2.5 rounded-full" style={`background-color: ${lang.color};`}></span>
                                    <span class="text-[#c0caf5]">{lang.name}</span>
                                    <span class="text-[#565f89]">{lang.percentage}%</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                <!-- Top/Pinned Repositories -->
                {topRepos.length > 0 && (
                    <div class="top-repos">
                        <div class="text-[#7aa2f7] mb-2 flex items-center gap-2">
                            <span class="text-[#565f89]">└─▶</span>
                            <span class="text-[#e0af68]">ls</span>
                            <span>{hasFullData && pinnedRepos.length > 0 ? 'pinned-repos/' : 'top-repos/'}</span>
                        </div>
                        <div class="ml-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
                            {topRepos.map((repo: any) => (
                                <a 
                                    href={hasFullData ? repo.url : repo.html_url} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    class="repo-card block p-3 border border-[#7aa2f7]/20 rounded-lg hover:border-[#7aa2f7]/50 hover:bg-[#7aa2f7]/5 transition-all"
                                >
                                    <div class="flex items-center gap-2 mb-1">
                                        <Icon name="lucide:book-marked" class="w-4 h-4 text-[#7aa2f7]" />
                                        <span class="text-[#7aa2f7] font-medium truncate">{repo.name}</span>
                                    </div>
                                    {repo.description && (
                                        <p class="text-[#565f89] text-xs mb-2 line-clamp-2">{repo.description}</p>
                                    )}
                                    <div class="flex items-center gap-3 text-xs">
                                        {(hasFullData ? repo.primaryLanguage : repo.language) && (
                                            <span class="flex items-center gap-1">
                                                <span 
                                                    class="w-2 h-2 rounded-full" 
                                                    style={`background-color: ${hasFullData ? repo.primaryLanguage?.color : getLanguageColor(repo.language)};`}
                                                ></span>
                                                <span class="text-[#c0caf5]">{hasFullData ? repo.primaryLanguage?.name : repo.language}</span>
                                            </span>
                                        )}
                                        <span class="flex items-center gap-1 text-[#e0af68]">
                                            <Icon name="lucide:star" class="w-3 h-3" />
                                            {hasFullData ? repo.stargazerCount : repo.stargazers_count}
                                        </span>
                                        <span class="flex items-center gap-1 text-[#7dcfff]">
                                            <Icon name="lucide:git-fork" class="w-3 h-3" />
                                            {hasFullData ? repo.forkCount : repo.forks_count}
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        ) : (
            <div class="text-[#f7768e]">
                <span class="text-[#565f89]">└─▶</span> Unable to fetch GitHub data. API may be rate limited.
            </div>
        )}
    </div>
</section>

<style>
    .contribution-day[data-level="0"] { background-color: #1a1b26; border: 1px solid rgba(122, 162, 247, 0.2); }
    .contribution-day[data-level="1"] { background-color: #0e4429; }
    .contribution-day[data-level="2"] { background-color: #006d32; }
    .contribution-day[data-level="3"] { background-color: #26a641; }
    .contribution-day[data-level="4"] { background-color: #39d353; }
    
    .repo-card:hover { transform: translateY(-2px); }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
</style>
