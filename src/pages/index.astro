---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import About from '../components/About.astro';
import Skills from '../components/Skills.astro';
import Contact from '../components/Contact.astro';
import Projects from '../components/Projects.astro';
import Experience from '../components/Experience.astro';
import Welcome from '../components/Welcome.astro';

// Welcome to Astro! Wondering what to do next? Check out the Astro documentation at https://docs.astro.build
// Don't want to use any of this? Delete everything in this file, the `assets`, `components`, and `layouts` directories, and start fresh.
---

<Layout>
	<div class="flex items-center justify-center min-h-screen bg-[#16161e] p-4">
		<div class="terminal-container w-full max-w-6xl shadow-2xl border border-[#7aa2f7]/20 rounded overflow-hidden">
			<!-- Mobile Notice -->
			<div class="sm:hidden bg-[#1a1b26] border border-[#f7768e] rounded-lg p-3 mb-4 text-center">
				<p class="text-[#f7768e] text-sm">‚ö†Ô∏è For the best terminal experience, please use a desktop browser.</p>
			</div>

			<!-- Terminal Header -->
			<div class="terminal-title-bar">
				<div class="terminal-buttons">
					<span class="terminal-button bg-[#f7768e]"></span>
					<span class="terminal-button bg-[#e0af68]"></span>
					<span class="terminal-button bg-[#9ece6a]"></span>
				</div>
				<div class="terminal-title">guest@dfanso.dev:~</div>
			</div>

			<!-- Terminal Content -->
			<div id="terminal" class="terminal-content-area">
				<div id="output-container">
					<!-- Welcome message -->
					<div class="command-block">
						<div class="command-prompt">guest@dfanso.dev:~$ <span class="text-[#9ece6a]">welcome</span></div>
						<div class="command-output"><Welcome /></div>
					</div>

					<!-- Whoami command -->
					<div class="command-block">
						<div class="command-prompt">guest@dfanso.dev:~$ <span class="text-[#9ece6a]">whoami</span></div>
						<div class="command-output"><Header /></div>
					</div>
				</div>

				<!-- Command Input -->
				<div class="command-block" id="input-line">
					<div class="command-prompt">
						guest@dfanso.dev:~$ <span class="command-text"></span><span class="cursor"></span>
					</div>
				</div>
			</div>

			<!-- Terminal Footer -->
			<div class="terminal-footer">
				<p class="text-xs text-[#7aa2f7]">Made with <span class="text-[#f7768e]">‚ù§</span> by DFanso</p>
			</div>

			<!-- Hidden Components -->
			<div id="components" class="hidden">
				<div id="welcome"><Welcome /></div>
				<div id="whoami"><Header /></div>
				<div id="about"><About /></div>
				<div id="projects"><Projects /></div>
				<div id="skills"><Skills /></div>
				<div id="experience"><Experience /></div>
				<div id="contact"><Contact /></div>
				<div id="help">
					<div class="command-list">
						<p>Available commands:</p>
						<ul class="ml-4 mt-2">
							<li><span class="text-[#9ece6a]">welcome</span> - Display welcome message</li>
							<li><span class="text-[#9ece6a]">whoami</span> - Show profile information</li>
							<li><span class="text-[#9ece6a]">about</span> - About me</li>
							<li><span class="text-[#9ece6a]">projects</span> - View my projects</li>
							<li><span class="text-[#9ece6a]">skills</span> - My technical skills</li>
							<li><span class="text-[#9ece6a]">experience</span> - Work experience</li>
							<li><span class="text-[#9ece6a]">contact</span> - Contact information</li>
							<li><span class="text-[#9ece6a]">clear</span> - Clear terminal</li>
							<li><span class="text-[#9ece6a]">help</span> - Show this help message</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</Layout>

<script>
	class Terminal {
		private terminal: HTMLElement;
		private outputContainer: HTMLElement;
		private inputLine: HTMLElement;
		private currentInput: string = '';
		private commandHistory: string[] = [];
		private historyIndex: number = -1;
		private awaitingProjectResponse: boolean = false;

		constructor() {
			this.terminal = document.getElementById('terminal') as HTMLElement;
			this.outputContainer = document.getElementById('output-container') as HTMLElement;
			this.inputLine = document.getElementById('input-line') as HTMLElement;
			this.initializeTerminal();
		}

		private initializeTerminal(): void {
			document.addEventListener('click', () => this.focusInput());
			document.addEventListener('keydown', (e: KeyboardEvent) => {
				if (e.key === 'Enter') {
					this.handleEnter();
				} else if (e.key === 'Backspace') {
					this.handleBackspace();
				} else if (e.key === 'ArrowUp') {
					this.handleArrowUp();
					e.preventDefault();
				} else if (e.key === 'ArrowDown') {
					this.handleArrowDown();
					e.preventDefault();
				} else if (e.key.length === 1) {
					this.handleInput(e.key);
				}
			});
		}

		private handleEnter(): void {
			const command = this.currentInput.trim().toLowerCase();
			if (command) {
				// Clone current input line without cursor
				const inputClone = this.inputLine.cloneNode(true) as HTMLElement;
				inputClone.removeAttribute('id');
				const commandText = inputClone.querySelector('.command-text');
				if (commandText) {
					commandText.textContent = this.currentInput;
				}
				const cursor = inputClone.querySelector('.cursor');
				if (cursor) {
					cursor.remove();
				}

				// Add command output
				const outputDiv = document.createElement('div');
				outputDiv.className = 'command-output';
				inputClone.appendChild(outputDiv);

				// Add to history
				this.commandHistory.push(command);
				this.historyIndex = this.commandHistory.length;

				// Execute command
				this.executeCommand(command, outputDiv);

				// Add to output container
				this.outputContainer.appendChild(inputClone);
			}

			// Reset input
			this.currentInput = '';
			this.updateInputLine();
			this.terminal.scrollTop = this.terminal.scrollHeight;
		}

		private executeCommand(command: string, outputDiv: HTMLElement): void {
			if (command === 'clear') {
				this.outputContainer.innerHTML = '';
				return;
			}

			const componentId = command === 'whoami' ? 'whoami' : command;
			const component = document.getElementById(componentId);

			if (component) {
				outputDiv.innerHTML = component.innerHTML;
				
				// Add interactive project prompt if it's the projects command
				if (command === 'projects') {
					const promptDiv = document.createElement('div');
					promptDiv.className = 'mt-4 text-[#9ece6a]';
					promptDiv.innerHTML = 'Would you like to see more projects? (yes/no)';
					outputDiv.appendChild(promptDiv);
					
					// Set a flag to handle the next input differently
					this.awaitingProjectResponse = true;
				}
			} else if (this.awaitingProjectResponse) {
				const response = command.toLowerCase();
				if (response === 'yes') {
					outputDiv.innerHTML = `<div class="text-[#9ece6a]">
						<p class="mb-2">üîó Check out more of my projects:</p>
						<a href="https://github.com/dfanso" target="_blank" class="text-[#7aa2f7] hover:text-[#9ece6a] transition-colors">
							‚Üí Visit my GitHub Profile
						</a>
					</div>`;
				} else if (response === 'no') {
					outputDiv.innerHTML = '<div class="text-[#9ece6a]">Alright! Feel free to explore other commands using `help`.</div>';
				} else {
					outputDiv.innerHTML = '<div class="text-[#f7768e]">Please answer with yes or no.</div>';
					this.awaitingProjectResponse = true;
					return;
				}
				this.awaitingProjectResponse = false;
			} else {
				outputDiv.innerHTML = `<div class="text-[#f7768e]">Command not found: ${command}</div>`;
			}
		}

		private handleBackspace(): void {
			if (this.currentInput.length > 0) {
				this.currentInput = this.currentInput.slice(0, -1);
				this.updateInputLine();
			}
		}

		private handleArrowUp(): void {
			if (this.historyIndex > 0) {
				this.historyIndex--;
				this.currentInput = this.commandHistory[this.historyIndex];
				this.updateInputLine();
			}
		}

		private handleArrowDown(): void {
			if (this.historyIndex < this.commandHistory.length - 1) {
				this.historyIndex++;
				this.currentInput = this.commandHistory[this.historyIndex];
			} else {
				this.historyIndex = this.commandHistory.length;
				this.currentInput = '';
			}
			this.updateInputLine();
		}

		private handleInput(key: string): void {
			this.currentInput += key;
			this.updateInputLine();
		}

		private updateInputLine(): void {
			const commandText = this.inputLine.querySelector('.command-text');
			if (commandText) {
				commandText.textContent = this.currentInput;
			}
		}

		private focusInput(): void {
			// Just ensure cursor is visible
			const cursor = this.inputLine.querySelector('.cursor');
			if (!cursor) {
				const newCursor = document.createElement('span');
				newCursor.className = 'cursor';
				const commandText = this.inputLine.querySelector('.command-text');
				if (commandText) {
					commandText.parentNode?.insertBefore(newCursor, commandText.nextSibling);
				}
			}
		}
	}

	// Initialize terminal when the page loads
	window.addEventListener('load', () => {
		new Terminal();
	});
</script>

<style>
	.terminal-container {
		@apply bg-[#1a1b26];
		font-family: 'Fira Code', monospace;
		height: 90vh;
		box-shadow: 0 0 20px rgba(0, 0, 0, 0.4),
					0 0 60px rgba(122, 162, 247, 0.1);
	}

	.terminal-title-bar {
		@apply flex items-center bg-[#1a1b26] border-b border-[#7aa2f7]/20 p-1;
		background: #1a1b26;
	}

	.terminal-buttons {
		@apply flex gap-1.5 mr-3;
	}

	.terminal-button {
		@apply w-2.5 h-2.5 rounded-full opacity-70 hover:opacity-100;
	}

	.terminal-title {
		@apply text-[#7aa2f7] text-xs opacity-80;
	}

	.terminal-content-area {
		@apply p-2 overflow-auto space-y-2;
		height: calc(90vh - 6rem);
		background: #1a1b26;
		font-family: 'Fira Code', monospace;
	}

	.command-block {
		@apply mb-2;
	}

	.command-prompt {
		@apply text-[#7aa2f7] mb-1 flex items-center flex-wrap text-sm;
		font-family: 'Fira Code', monospace;
	}

	.command-output {
		@apply pl-4 py-1 text-sm opacity-90;
	}

	.cursor {
		@apply ml-[1px] -mr-[1px] opacity-70;
	}

	.cursor::after {
		content: "‚ñã";
		animation: cursor-blink 0.8s step-end infinite;
	}

	@keyframes cursor-blink {
		0%, 100% { opacity: 1; }
		50% { opacity: 0; }
	}

	/* Custom Scrollbar - More minimal */
	.terminal-content-area {
		scrollbar-width: thin;
		scrollbar-color: rgba(122, 162, 247, 0.3) transparent;
	}

	.terminal-content-area::-webkit-scrollbar {
		width: 2px;
	}

	.terminal-content-area::-webkit-scrollbar-thumb {
		background-color: rgba(122, 162, 247, 0.3);
	}

	.command-list {
		@apply text-sm opacity-90;
	}

	.command-list ul {
		@apply space-y-0.5;
	}

	.terminal-footer {
		@apply fixed bottom-2 right-2 text-center opacity-50 hover:opacity-80 transition-opacity;
		font-family: 'Fira Code', monospace;
	}

	/* Mobile-specific styles */
	@media (max-width: 640px) {
		.command-prompt {
			word-break: break-all;
		}

		.terminal-content-area {
			-webkit-overflow-scrolling: touch;
		}
	}

	/* Remove fancy background effects */
	.terminal-container {
		background-image: none !important;
	}

	/* Adjust text colors for more terminal-like appearance */
	.text-[#c0caf5] {
		@apply opacity-90;
	}

	.welcome-text {
		@apply opacity-80;
	}

	/* Make the ASCII art more terminal-like */
	.ascii-art {
		@apply opacity-70;
	}
</style>
